<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Image Picker</title>
    <style>
        #status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <input type="file" accept="image/*" id="inputFile" style="display: none;" />
    <div id="status">Waiting for initialization...</div>

    <script>
        const status = document.getElementById('status');
        const inputFile = document.getElementById('inputFile');
        
        // Debug logging function
        function log(message) {
            status.textContent = message;
            console.log(message);
            try {
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage("DEBUG: " + message);
                }
            } catch (e) {
                console.error("Error sending debug message:", e);
            }
        }

        // Initialize
        log("Page loaded, setting up listeners...");

        // Listen for Thunkable messages
        window.addEventListener('message', function(event) {
            log("Received message: " + event.data);
            if (event.data === 'openPicker') {
                log("Opening file picker...");
                inputFile.click();
            }
        }, false);

        // Handle file selection
        inputFile.addEventListener('change', function(event) {
            log("File selected, processing...");
            const file = event.target.files[0];
            
            if (!file) {
                log("No file selected");
                return;
            }

            log("File type: " + file.type + ", size: " + file.size + " bytes");

            const reader = new FileReader();
            
            reader.onloadstart = () => log("Starting file read...");
            
            reader.onload = function(e) {
                log("File read complete, sending to Thunkable...");
                const base64 = e.target.result;
                
                // Try multiple methods to communicate with Thunkable
                try {
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(base64);
                        log("Sent via ReactNativeWebView");
                    } else {
                        window.parent.postMessage(base64, '*');
                        log("Sent via postMessage");
                    }
                } catch (error) {
                    log("Error sending: " + error.message);
                }
            };

            reader.onerror = function(error) {
                log("Error reading file: " + error);
            };

            try {
                reader.readAsDataURL(file);
            } catch (error) {
                log("Error starting file read: " + error);
            }
        });

        // Test communication with Thunkable
        setTimeout(() => {
            log("Testing Thunkable communication...");
            try {
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage("TEST_MESSAGE");
                    log("Test message sent via ReactNativeWebView");
                } else {
                    window.parent.postMessage("TEST_MESSAGE", '*');
                    log("Test message sent via postMessage");
                }
            } catch (error) {
                log("Error sending test message: " + error);
            }
        }, 1000);
    </script>
</body>
</html>
